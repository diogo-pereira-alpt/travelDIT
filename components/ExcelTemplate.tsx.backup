'use client'

import ExcelJS from 'exceljs'
import { saveAs } from 'file-saver'
import { format } from 'date-fns'

// Check if running in Tauri - improved detection
const isTauri = typeof window !== 'undefined' && 
  (typeof (window as any).__TAURI__ !== 'undefined' || 
   typeof (window as any).__TAURI_METADATA__ !== 'undefined')

// Toast notification interface
interface ToastMessage {
  type: 'success' | 'error' | 'info'
  title: string
  message: string
  duration?: number
  actionButton?: {
    text: string
    onClick: () => void
  }
}

// Helper function to get default download path
const getDownloadPath = (): string => {
  if (isTauri) {
    // In Tauri, assume default Windows Downloads folder
    const username = process.env.USERNAME || 'user'
    return `C:\\Users\\${username}\\Downloads`
  }
  return 'Downloads'
}

// Simplified approach - just open downloads with PowerShell
const openDownloadsDirectly = async () => {
  if (isTauri && (window as any).__TAURI__) {
    try {
      console.log('üîÑ Trying to open Downloads folder...')
      const { Command } = (window as any).__TAURI__.shell
      
      // Simple PowerShell command that should always work
      const command = new Command('powershell', ['-Command', 'Invoke-Item $env:USERPROFILE\\Downloads'])
      const result = await command.execute()
      
      console.log('‚úÖ PowerShell result:', result)
      return result.code === 0
    } catch (error) {
      console.error('‚ùå PowerShell failed:', error)
      
      // Final fallback - explorer command
      try {
        const { Command } = (window as any).__TAURI__.shell
        const command = new Command('explorer', ['%USERPROFILE%\\Downloads'])
        const result = await command.execute()
        console.log('‚úÖ Explorer fallback result:', result)
        return result.code === 0
      } catch (explorerError) {
        console.error('‚ùå Explorer also failed:', explorerError)
        return false
      }
    }
  }
  return false
}

// Simple function to open downloads folder
const openDownloadsFolder = async (filename?: string) => {
  console.log('üìÇ Opening downloads folder...')
  
  // Try to open Downloads folder directly in any environment
  if (isTauri && (window as any).__TAURI__) {
    // Tauri app - use shell commands to open Downloads folder
    const success = await openDownloadsDirectly()
    
    if (success) {
      showToast({
        type: 'success',
        title: 'üìÅ Pasta Aberta!',
        message: 'Pasta Downloads aberta no Explorador',
        duration: 3000
      })
    } else {
      showToast({
        type: 'error',
        title: '‚ùå Erro',
        message: 'N√£o foi poss√≠vel abrir a pasta automaticamente',
        duration: 4000
      })
    }
  } else {
    // Browser environment - try to use window.open or show alternative
    try {
      // Try to open Downloads folder via file protocol (may work in some browsers)
      const downloadPath = `file:///${getDownloadPath().replace(/\\/g, '/')}`
      window.open(downloadPath, '_blank')
      
      showToast({
        type: 'info',
        title: 'üìÅ Tentativa de Abertura',
        message: 'A tentar abrir a pasta Downloads. Se n√£o funcionar, use Ctrl+J.',
        duration: 4000
      })
    } catch (error) {
      // Fallback - show how to access downloads
      showToast({
        type: 'info',
        title: 'üìÅ Ver Downloads',
        message: 'Prima Ctrl+J para ver os downloads do browser',
        duration: 4000
      })
    }
  }
}

// Global toast function - this will be passed from the main component
let showToast: (toast: ToastMessage) => void = (toast) => {
  // Fallback to alert if no toast system is connected
  alert(`${toast.title}\n${toast.message}`)
}

// Function to set the toast handler
export const setToastHandler = (handler: (toast: ToastMessage) => void) => {
  showToast = handler
}

// Interfaces baseadas no backup
interface ColaboradorData {
  apelido: string
  primeiro_nome: string
  num_colaborador: string
  direcao: string
  centro_custo: string
  bi_cc: string
}

interface AviaoViagem {
  origem: string
  destino: string
  data: string
  hora_chegada: string
  hora_partida: string
  observacoes: string
}

interface AlojamentoReserva {
  cidade: string
  hotel: string
  data_chegada: string
  data_partida: string
  tipo_quarto: string
  observacoes: string
}

interface AutomovelAluguer {
  cidade_levantamento: string
  local_levantamento: string
  data_levantamento: string
  hora_levantamento: string
  cidade_devolucao: string
  local_devolucao: string
  data_devolucao: string
  hora_devolucao: string
  tipo_viatura: string
  observacoes: string
}

interface ComboioViagem {
  local_partida: string
  local_destino: string
  data: string
  hora_partida: string
  classe: string
}

interface TravelFormData {
  colaborador: ColaboradorData
  tem_aviao: boolean
  aviao_viagens: AviaoViagem[]
  tem_alojamento: boolean
  alojamentos: AlojamentoReserva[]
  tem_automovel: boolean
  automoveis: AutomovelAluguer[]
  tem_outros: boolean
  outros_servicos: string
  tem_comboio: boolean
  comboio_ida: ComboioViagem
  tem_regresso: boolean
  comboio_regresso: ComboioViagem
  observacoes_ida: string
  observacoes_regresso: string
}

export const generateExcelFromTemplate = async (formData: TravelFormData): Promise<void> => {
  try {
    // Ler o template original
    const response = await fetch('/TemplateViagens_template.xlsx')
    if (!response.ok) {
      throw new Error('N√£o foi poss√≠vel carregar o template Excel')
    }

    const buffer = await response.arrayBuffer()
    const workbook = new ExcelJS.Workbook()
    await workbook.xlsx.load(buffer)

    const worksheet = workbook.getWorksheet(1) // Primeira sheet
    if (!worksheet) {
      throw new Error('N√£o foi poss√≠vel acessar a worksheet')
    }

    // Preencher dados do colaborador (linha 8, baseado na estrutura)
    worksheet.getCell(8, 2).value = formData.colaborador.apelido
    worksheet.getCell(8, 3).value = formData.colaborador.primeiro_nome
    worksheet.getCell(8, 4).value = formData.colaborador.num_colaborador
    worksheet.getCell(8, 5).value = formData.colaborador.direcao
    worksheet.getCell(8, 6).value = formData.colaborador.centro_custo
    worksheet.getCell(8, 7).value = formData.colaborador.bi_cc

    // Preencher dados do avi√£o (linhas 24-29)
    if (formData.tem_aviao) {
      formData.aviao_viagens.slice(0, 6).forEach((viagem, index) => {
        const row = 24 + index
        worksheet.getCell(row, 2).value = viagem.origem
        worksheet.getCell(row, 3).value = viagem.destino
        worksheet.getCell(row, 4).value = viagem.data
        worksheet.getCell(row, 5).value = viagem.hora_chegada
        worksheet.getCell(row, 6).value = viagem.hora_partida
        worksheet.getCell(row, 7).value = viagem.observacoes
      })
    }

    // Preencher dados do alojamento (linhas 36-41)
    if (formData.tem_alojamento) {
      formData.alojamentos.slice(0, 6).forEach((alojamento, index) => {
        const row = 36 + index
        worksheet.getCell(row, 2).value = alojamento.cidade
        worksheet.getCell(row, 3).value = alojamento.hotel
        worksheet.getCell(row, 4).value = alojamento.data_chegada
        worksheet.getCell(row, 5).value = alojamento.data_partida
        worksheet.getCell(row, 6).value = alojamento.tipo_quarto
        worksheet.getCell(row, 7).value = alojamento.observacoes
      })
    }

    // Preencher dados do autom√≥vel (linhas 49-54)
    if (formData.tem_automovel) {
      formData.automoveis.slice(0, 6).forEach((auto, index) => {
        const row = 49 + index
        worksheet.getCell(row, 2).value = auto.cidade_levantamento
        worksheet.getCell(row, 3).value = auto.local_levantamento
        worksheet.getCell(row, 4).value = auto.data_levantamento
        worksheet.getCell(row, 5).value = auto.hora_levantamento
        worksheet.getCell(row, 6).value = auto.cidade_devolucao
        worksheet.getCell(row, 7).value = auto.local_devolucao
        worksheet.getCell(row, 8).value = auto.data_devolucao
        worksheet.getCell(row, 9).value = auto.hora_devolucao
        worksheet.getCell(row, 10).value = auto.tipo_viatura
        worksheet.getCell(row, 11).value = auto.observacoes
      })
    }

    // Preencher outros servi√ßos (linha 60)
    if (formData.tem_outros) {
      worksheet.getCell(60, 2).value = formData.outros_servicos
    }

    // Preencher dados do comboio (linha 92)
    if (formData.tem_comboio) {
      // Ida (colunas 2-6)
      worksheet.getCell(92, 2).value = formData.comboio_ida.local_partida
      worksheet.getCell(92, 3).value = formData.comboio_ida.local_destino
      worksheet.getCell(92, 4).value = formData.comboio_ida.data
      worksheet.getCell(92, 5).value = formData.comboio_ida.hora_partida
      worksheet.getCell(92, 6).value = formData.comboio_ida.classe

      // Regresso (colunas 7-11) se ativo
      if (formData.tem_regresso) {
        worksheet.getCell(92, 7).value = formData.comboio_regresso.local_partida
        worksheet.getCell(92, 8).value = formData.comboio_regresso.local_destino
        worksheet.getCell(92, 9).value = formData.comboio_regresso.data
        worksheet.getCell(92, 10).value = formData.comboio_regresso.hora_partida
        worksheet.getCell(92, 11).value = formData.comboio_regresso.classe
      }

      // Observa√ß√µes (linha 102)
      if (formData.observacoes_ida) {
        worksheet.getCell(102, 2).value = formData.observacoes_ida
      }
      if (formData.observacoes_regresso) {
        worksheet.getCell(102, 7).value = formData.observacoes_regresso
      }
    }

    // Gerar nome do ficheiro
    const now = new Date()
    const timestamp = format(now, 'dd_MM_yyyy')
    const filename = `TemplateViagens_${timestamp}.xlsx`

    // Fazer download com feedback melhorado
    const buffer2 = await workbook.xlsx.writeBuffer()
    const blob = new Blob([buffer2], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' })
    
    // Make the download
    saveAs(blob, filename)
    
    // Debug logging
    console.log('üîç Environment detection:')
    console.log('- isTauri:', isTauri)
    console.log('- __TAURI__:', typeof (window as any).__TAURI__)
    console.log('- __TAURI_METADATA__:', typeof (window as any).__TAURI_METADATA__)
    console.log('- User Agent:', navigator.userAgent)
    
    if (isTauri) {
      // Tauri: Simple success message with manual button
      showToast({
        type: 'success',
        title: '‚úÖ Download Conclu√≠do!',
        message: `Ficheiro: ${filename}\nGuardado na pasta Downloads`,
        duration: 10000,
        actionButton: {
          text: 'üìÅ Abrir Pasta Downloads',
          onClick: () => openDownloadsFolder(filename)
        }
      })
    } else {
      // Em browser normal - solu√ß√£o mais simples e funcional
      showToast({
        type: 'success',
        title: '‚úÖ Download Conclu√≠do!',
        message: `Ficheiro ${filename} transferido com sucesso!\n\nüìÅ Localiza√ß√£o: Pasta Downloads do browser\nüîç Para encontrar: Prima Ctrl+J`,
        duration: 12000,
        actionButton: {
          text: 'üìÅ Abrir Pasta Downloads',
          onClick: () => openDownloadsFolder(filename)
            const instructions = `
üìÑ Ficheiro: ${filename}

ÔøΩ Como encontrar o ficheiro:

‚úÖ M√âTODO 1 - Downloads do Browser:
‚Ä¢ Prima Ctrl+J (Chrome/Edge) ou Ctrl+Shift+Y (Firefox)
‚Ä¢ O ficheiro aparece na lista de downloads

‚úÖ M√âTODO 2 - Pasta Downloads:
‚Ä¢ Abra o Explorador de Ficheiros
‚Ä¢ V√° para a pasta Downloads
‚Ä¢ Procure pelo ficheiro ${filename}

‚úÖ M√âTODO 3 - Barra de Downloads:
‚Ä¢ Verifique a barra inferior do browser
‚Ä¢ O ficheiro deve aparecer como download recente

üí° Dica: Clique no ficheiro na barra de downloads para abrir!
            `;
            
            // Use a custom alert that's more readable
            if (confirm(instructions + '\n\nClique OK para copiar o nome do ficheiro')) {
              if (navigator.clipboard) {
                navigator.clipboard.writeText(filename);
                showToast({
                  type: 'info',
                  title: 'Nome copiado!',
                  message: 'Nome do ficheiro copiado. Use Ctrl+F na pasta Downloads para encontr√°-lo rapidamente.',
                  duration: 4000
                });
              }
            }
          }
        }
      })
    }

  } catch (error) {
    console.error('Erro ao gerar Excel:', error)
    showToast({
      type: 'error',
      title: '‚ùå Erro no Download',
      message: `Erro ao gerar Excel: ${error instanceof Error ? error.message : 'Erro desconhecido'}`,
      duration: 8000
    })
    throw new Error(`Erro ao gerar Excel: ${error instanceof Error ? error.message : 'Erro desconhecido'}`)
  }
}

// Manter a fun√ß√£o antiga para compatibilidade
interface TravelData {
  startDate: Date
  endDate: Date
  destination: string
  nights: number
  accommodation: number
  cityTax: number
  transport: number
  total: number
  transportType: string
}

export const createTravelTemplate = (data: TravelData) => {
  // Import necess√°rio para a fun√ß√£o antiga
  const XLSX = require('xlsx')
  // Dados de identifica√ß√£o (preenchidos por default)
  const identification = [
    ['IDENTIFICA√á√ÉO'],
    ['Nome:', 'Diogo Pereira'],
    ['N√∫mero de Colaborador:', '123456'],
    ['Fun√ß√£o:', 'IT Specialist'],
    ['Departamento:', 'Tecnologia'],
    ['Centro de Custo:', 'TEC001'],
    ['E-mail:', 'diogo.pereira@empresa.com'],
    [''],
  ]

  // Dados da viagem
  const travelInfo = [
    ['DADOS DA VIAGEM'],
    ['Destino:', data.destination],
    ['Data de Partida:', format(data.startDate, 'dd/MM/yyyy')],
    ['Data de Regresso:', format(data.endDate, 'dd/MM/yyyy')],
    ['N√∫mero de Noites:', data.nights],
    ['Motivo da Viagem:', 'Hackathon/Evento Corporativo'],
    [''],
  ]

  // Dados dos custos
  const costInfo = [
    ['CUSTOS'],
    ['Estadia (85‚Ç¨/noite/pessoa):', `${data.accommodation.toFixed(2)}‚Ç¨`],
    ['City Tax (4‚Ç¨/noite/pessoa):', `${data.cityTax.toFixed(2)}‚Ç¨`],
    ['Transporte:', `${data.transport.toFixed(2)}‚Ç¨`],
    ['Tipo de Transporte:', data.transportType],
    [''],
    ['TOTAL GERAL:', `${data.total.toFixed(2)}‚Ç¨`],
  ]

  // Combinar todos os dados
  const allData = [...identification, ...travelInfo, ...costInfo]

  // Criar workbook
  const ws = XLSX.utils.aoa_to_sheet(allData)

  // Definir estilos (larguras das colunas)
  ws['!cols'] = [
    { width: 25 }, // Coluna A
    { width: 20 }, // Coluna B
  ]

  const wb = XLSX.utils.book_new()
  XLSX.utils.book_append_sheet(wb, ws, 'Solicita√ß√£o de Viagem')

  // Gerar nome do ficheiro com data atual
  const today = new Date()
  const fileName = `TemplateViagens_${format(today, 'dd_MM_yyyy')}.xlsx`

  // Fazer download
  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' })
  const blob = new Blob([wbout], { type: 'application/octet-stream' })
  saveAs(blob, fileName)
}

export const generateEmailContent = (data: TravelData): string => {
  const formatDateForEmail = (date: Date) => format(date, 'dd \'de\' MMMM')

  const transportText = data.transportType === 'train-one' ? 'Comboio 36 Eur (apenas ida)' :
                       data.transportType === 'train-round' ? 'Comboio 72 Eur (ida e volta)' :
                       data.transportType === 'car' ? 'Carro (sem custos adicionais)' :
                       ''

  return `Ol√° Paulo,

No seguimento da Hackathon de dia 16, 18 e 19, solicito o OK para pedir estadia e viagem para ${data.destination} de ${formatDateForEmail(data.startDate)} a ${formatDateForEmail(data.endDate)}.

Estadia: 85,00 Eur / noite / pessoa ${data.accommodation.toFixed(2)}‚Ç¨
City Tax: 4,00 Eur / noite / pessoa ${data.cityTax.toFixed(2)}‚Ç¨
${transportText ? transportText : ''}

Total: ${data.total.toFixed(2)}‚Ç¨

Obrigado desde j√°,
Os meus cumprimentos,`
}
