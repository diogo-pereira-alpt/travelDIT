'use client'

import { useState, useCallback } from 'react'
import { format } from 'date-fns'
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select"
import { Button } from "@/components/ui/button"
import { Label } from "@/components/ui/label"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"
import { Download, Mail, Plus, Trash2, User, Plane, Hotel, Car, Train } from 'lucide-react'
import meoLogo from "@/images/meo.png"
import ExcelJS from 'exceljs'
import { saveAs } from 'file-saver'

// Interfaces para os dados do formul√°rio
interface ColaboradorData {
  apelido: string
  primeiro_nome: string
  num_colaborador: string
  direcao: string
  centro_custo: string
  bi_cc: string
}

interface AviaoViagem {
  origem: string
  destino: string
  data: string
  hora_chegada: string
  hora_partida: string
  observacoes: string
}

interface AlojamentoReserva {
  cidade: string
  hotel: string
  data_chegada: string
  data_partida: string
  tipo_quarto: string
  observacoes: string
}

interface AutomovelAluguer {
  cidade_levantamento: string
  local_levantamento: string
  data_levantamento: string
  hora_levantamento: string
  cidade_devolucao: string
  local_devolucao: string
  data_devolucao: string
  hora_devolucao: string
  tipo_viatura: string
  observacoes: string
}

interface ComboioViagem {
  local_partida: string
  local_destino: string
  data: string
  hora_partida: string
  classe: string
}

interface TravelFormData {
  colaborador: ColaboradorData
  tem_aviao: boolean
  aviao_viagens: AviaoViagem[]
  tem_alojamento: boolean
  alojamentos: AlojamentoReserva[]
  tem_automovel: boolean
  automoveis: AutomovelAluguer[]
  tem_outros: boolean
  outros_servicos: string
  tem_comboio: boolean
  comboio_ida: ComboioViagem
  tem_regresso: boolean
  comboio_regresso: ComboioViagem
  observacoes_ida: string
  observacoes_regresso: string
}

const Header = ({ title }: { title: string }) => {
  return (
    <header className="bg-black text-white p-4 flex justify-between items-center">
      <h1 className="text-xl font-bold">{title}</h1>
      <img src={meoLogo.src} alt="logo" width={60} height={30} />
    </header>
  )
}

interface FormSectionProps {
  title: string
  icon: React.ReactNode
  isActive: boolean
  onToggle: (active: boolean) => void
  children: React.ReactNode
}

const FormSection = ({ title, icon, isActive, onToggle, children }: FormSectionProps) => (
  <Card className="mb-6">
    <CardHeader>
      <div className="flex items-center justify-between">
        <div className="flex items-center space-x-2">
          {icon}
          <CardTitle className="text-lg">{title}</CardTitle>
        </div>
        <label className="flex items-center space-x-2 cursor-pointer">
          <input
            type="checkbox"
            checked={isActive}
            onChange={(e) => onToggle(e.target.checked)}
            className="w-5 h-5"
          />
          <span className="text-sm">Ativar</span>
        </label>
      </div>
    </CardHeader>
    {isActive && (
      <CardContent>
        {children}
      </CardContent>
    )}
  </Card>
)

export default function TravelTemplateApp() {
  const [formData, setFormData] = useState<TravelFormData>({
    colaborador: {
      apelido: 'Pereira',
      primeiro_nome: 'Paulo',
      num_colaborador: '10059580',
      direcao: 'AIC',
      centro_custo: '001-3751',
      bi_cc: '15469466'
    },
    tem_aviao: false,
    aviao_viagens: [{ origem: '', destino: '', data: '', hora_chegada: '', hora_partida: '', observacoes: '' }],
    tem_alojamento: false,
    alojamentos: [{ cidade: '', hotel: '', data_chegada: '', data_partida: '', tipo_quarto: '1PAX', observacoes: '' }],
    tem_automovel: false,
    automoveis: [{
      cidade_levantamento: '', local_levantamento: '', data_levantamento: '', hora_levantamento: '',
      cidade_devolucao: '', local_devolucao: '', data_devolucao: '', hora_devolucao: '',
      tipo_viatura: 'Compacto', observacoes: ''
    }],
    tem_outros: false,
    outros_servicos: '',
    tem_comboio: false,
    comboio_ida: { local_partida: '', local_destino: '', data: '', hora_partida: '', classe: '' },
    tem_regresso: false,
    comboio_regresso: { local_partida: '', local_destino: '', data: '', hora_partida: '', classe: '' },
    observacoes_ida: '',
    observacoes_regresso: ''
  })

  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const updateColaborador = (field: keyof ColaboradorData, value: string) => {
    setFormData(prev => ({
      ...prev,
      colaborador: { ...prev.colaborador, [field]: value }
    }))
  }

  const updateAviaoViagem = (index: number, field: keyof AviaoViagem, value: string) => {
    setFormData(prev => ({
      ...prev,
      aviao_viagens: prev.aviao_viagens.map((v, i) =>
        i === index ? { ...v, [field]: value } : v
      )
    }))
  }

  const updateAlojamento = (index: number, field: keyof AlojamentoReserva, value: string) => {
    setFormData(prev => ({
      ...prev,
      alojamentos: prev.alojamentos.map((a, i) =>
        i === index ? { ...a, [field]: value } : a
      )
    }))
  }

  const updateAutomovel = (index: number, field: keyof AutomovelAluguer, value: string) => {
    setFormData(prev => ({
      ...prev,
      automoveis: prev.automoveis.map((a, i) =>
        i === index ? { ...a, [field]: value } : a
      )
    }))
  }

  const addViagem = (type: 'aviao' | 'alojamento' | 'automovel') => {
    setFormData(prev => {
      if (type === 'aviao') {
        return {
          ...prev,
          aviao_viagens: [...prev.aviao_viagens, { origem: '', destino: '', data: '', hora_chegada: '', hora_partida: '', observacoes: '' }]
        }
      } else if (type === 'alojamento') {
        return {
          ...prev,
          alojamentos: [...prev.alojamentos, { cidade: '', hotel: '', data_chegada: '', data_partida: '', tipo_quarto: '1PAX', observacoes: '' }]
        }
      } else {
        return {
          ...prev,
          automoveis: [...prev.automoveis, {
            cidade_levantamento: '', local_levantamento: '', data_levantamento: '', hora_levantamento: '',
            cidade_devolucao: '', local_devolucao: '', data_devolucao: '', hora_devolucao: '',
            tipo_viatura: 'Compacto', observacoes: ''
          }]
        }
      }
    })
  }

  const removeViagem = (type: 'aviao' | 'alojamento' | 'automovel', index: number) => {
    setFormData(prev => {
      if (type === 'aviao') {
        return { ...prev, aviao_viagens: prev.aviao_viagens.filter((_, i) => i !== index) }
      } else if (type === 'alojamento') {
        return { ...prev, alojamentos: prev.alojamentos.filter((_, i) => i !== index) }
      } else {
        return { ...prev, automoveis: prev.automoveis.filter((_, i) => i !== index) }
      }
    })
  }

  const generateExcel = useCallback(async () => {
    setLoading(true)
    setError(null)

    try {
      // Ler o template original
      const response = await fetch('/TemplateViagens_template.xlsx')
      if (!response.ok) {
        throw new Error('N√£o foi poss√≠vel carregar o template Excel')
      }
      
      const buffer = await response.arrayBuffer()
      const workbook = new ExcelJS.Workbook()
      await workbook.xlsx.load(buffer)
      
      const worksheet = workbook.getWorksheet(1) // Primeira sheet
      if (!worksheet) {
        throw new Error('N√£o foi poss√≠vel acessar a worksheet')
      }

      // Preencher dados do colaborador (linha 8, baseado na estrutura)
      worksheet.getCell(8, 2).value = formData.colaborador.apelido
      worksheet.getCell(8, 3).value = formData.colaborador.primeiro_nome
      worksheet.getCell(8, 4).value = formData.colaborador.num_colaborador
      worksheet.getCell(8, 5).value = formData.colaborador.direcao
      worksheet.getCell(8, 6).value = formData.colaborador.centro_custo
      worksheet.getCell(8, 7).value = formData.colaborador.bi_cc

      // Preencher dados do avi√£o (linhas 24-29)
      if (formData.tem_aviao) {
        formData.aviao_viagens.slice(0, 6).forEach((viagem, index) => {
          const row = 24 + index
          worksheet.getCell(row, 2).value = viagem.origem
          worksheet.getCell(row, 3).value = viagem.destino
          worksheet.getCell(row, 4).value = viagem.data
          worksheet.getCell(row, 5).value = viagem.hora_chegada
          worksheet.getCell(row, 6).value = viagem.hora_partida
          worksheet.getCell(row, 7).value = viagem.observacoes
        })
      }

      // Preencher dados do alojamento (linhas 36-41)
      if (formData.tem_alojamento) {
        formData.alojamentos.slice(0, 6).forEach((alojamento, index) => {
          const row = 36 + index
          worksheet.getCell(row, 2).value = alojamento.cidade
          worksheet.getCell(row, 3).value = alojamento.hotel
          worksheet.getCell(row, 4).value = alojamento.data_chegada
          worksheet.getCell(row, 5).value = alojamento.data_partida
          worksheet.getCell(row, 6).value = alojamento.tipo_quarto
          worksheet.getCell(row, 7).value = alojamento.observacoes
        })
      }

      // Preencher dados do autom√≥vel (linhas 49-54)
      if (formData.tem_automovel) {
        formData.automoveis.slice(0, 6).forEach((auto, index) => {
          const row = 49 + index
          worksheet.getCell(row, 2).value = auto.cidade_levantamento
          worksheet.getCell(row, 3).value = auto.local_levantamento
          worksheet.getCell(row, 4).value = auto.data_levantamento
          worksheet.getCell(row, 5).value = auto.hora_levantamento
          worksheet.getCell(row, 6).value = auto.cidade_devolucao
          worksheet.getCell(row, 7).value = auto.local_devolucao
          worksheet.getCell(row, 8).value = auto.data_devolucao
          worksheet.getCell(row, 9).value = auto.hora_devolucao
          worksheet.getCell(row, 10).value = auto.tipo_viatura
          worksheet.getCell(row, 11).value = auto.observacoes
        })
      }

      // Preencher outros servi√ßos (linha 60)
      if (formData.tem_outros) {
        worksheet.getCell(60, 2).value = formData.outros_servicos
      }

      // Preencher dados do comboio (linha 92)
      if (formData.tem_comboio) {
        // Ida (colunas 2-6)
        worksheet.getCell(92, 2).value = formData.comboio_ida.local_partida
        worksheet.getCell(92, 3).value = formData.comboio_ida.local_destino
        worksheet.getCell(92, 4).value = formData.comboio_ida.data
        worksheet.getCell(92, 5).value = formData.comboio_ida.hora_partida
        worksheet.getCell(92, 6).value = formData.comboio_ida.classe

        // Regresso (colunas 7-11) se ativo
        if (formData.tem_regresso) {
          worksheet.getCell(92, 7).value = formData.comboio_regresso.local_partida
          worksheet.getCell(92, 8).value = formData.comboio_regresso.local_destino
          worksheet.getCell(92, 9).value = formData.comboio_regresso.data
          worksheet.getCell(92, 10).value = formData.comboio_regresso.hora_partida
          worksheet.getCell(92, 11).value = formData.comboio_regresso.classe
        }

        // Observa√ß√µes (linha 102)
        if (formData.observacoes_ida) {
          worksheet.getCell(102, 2).value = formData.observacoes_ida
        }
        if (formData.observacoes_regresso) {
          worksheet.getCell(102, 7).value = formData.observacoes_regresso
        }
      }

      // Gerar nome do ficheiro
      const now = new Date()
      const timestamp = format(now, 'dd_MM_yyyy')
      const filename = `TemplateViagens_${timestamp}.xlsx`

      // Fazer download
      const buffer2 = await workbook.xlsx.writeBuffer()
      const blob = new Blob([buffer2], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' })
      saveAs(blob, filename)

      alert('‚úÖ Template Excel gerado com sucesso!')

    } catch (err) {
      console.error('Erro ao gerar Excel:', err)
      setError(`Erro ao gerar Excel: ${err instanceof Error ? err.message : 'Erro desconhecido'}`)
    } finally {
      setLoading(false)
    }
  }, [formData])

  const generateEmail = useCallback(() => {
    // Implementar gera√ß√£o de email baseado nos dados do formul√°rio
    const emailContent = `Ol√° Paulo,

No seguimento da Hekathon de dia 16, 18 e 19, solicito o OK para pedir viagem.

Dados da viagem:
${formData.tem_alojamento ? `Alojamento: ${formData.alojamentos[0]?.cidade || ''} - ${formData.alojamentos[0]?.hotel || ''}` : ''}
${formData.tem_comboio ? `Comboio: ${formData.comboio_ida.local_partida} -> ${formData.comboio_ida.local_destino}` : ''}

Obrigado desde j√°,
Os meus cumprimentos,`

    navigator.clipboard.writeText(emailContent)
    alert('Email copiado para a √°rea de transfer√™ncia!')
  }, [formData])

  return (
    <div className="min-h-screen bg-gray-50">
      <Header title="Sistema de Template de Viagem" />
      
      <main className="container mx-auto p-6">
        <div className="mb-6 text-center">
          <h2 className="text-2xl font-bold text-gray-800 mb-2">
            üìã Gerador de Template Excel de Viagem
          </h2>
          <p className="text-gray-600">
            Preencha os dados necess√°rios e gere automaticamente o template Excel preenchido
          </p>
        </div>

        {error && (
          <Card className="mb-6 border-red-500 bg-red-50">
            <CardContent className="pt-6">
              <p className="text-red-600">‚ùå {error}</p>
            </CardContent>
          </Card>
        )}

        {/* DADOS DO COLABORADOR - Sempre vis√≠vel */}
        <Card className="mb-6 border-blue-500">
          <CardHeader>
            <div className="flex items-center space-x-2">
              <User className="h-5 w-5 text-blue-600" />
              <CardTitle className="text-lg text-blue-600">DADOS DO COLABORADOR (Obrigat√≥rio)</CardTitle>
            </div>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div>
                <Label htmlFor="apelido">Apelido (√∫ltimo nome)*</Label>
                <Input
                  id="apelido"
                  value={formData.colaborador.apelido}
                  onChange={(e) => updateColaborador('apelido', e.target.value)}
                  placeholder="Pereira"
                  required
                />
              </div>
              <div>
                <Label htmlFor="primeiro_nome">Primeiro Nome*</Label>
                <Input
                  id="primeiro_nome"
                  value={formData.colaborador.primeiro_nome}
                  onChange={(e) => updateColaborador('primeiro_nome', e.target.value)}
                  placeholder="Paulo"
                  required
                />
              </div>
              <div>
                <Label htmlFor="num_colaborador">N¬∫ Colaborador*</Label>
                <Input
                  id="num_colaborador"
                  value={formData.colaborador.num_colaborador}
                  onChange={(e) => updateColaborador('num_colaborador', e.target.value)}
                  placeholder="10059580"
                  required
                />
              </div>
              <div>
                <Label htmlFor="direcao">Dire√ß√£o*</Label>
                <Input
                  id="direcao"
                  value={formData.colaborador.direcao}
                  onChange={(e) => updateColaborador('direcao', e.target.value)}
                  placeholder="AIC"
                  required
                />
              </div>
              <div>
                <Label htmlFor="centro_custo">Centro Custo*</Label>
                <Input
                  id="centro_custo"
                  value={formData.colaborador.centro_custo}
                  onChange={(e) => updateColaborador('centro_custo', e.target.value)}
                  placeholder="001-3751"
                  required
                />
              </div>
              <div>
                <Label htmlFor="bi_cc">BI/Cart√£o Cidad√£o*</Label>
                <Input
                  id="bi_cc"
                  value={formData.colaborador.bi_cc}
                  onChange={(e) => updateColaborador('bi_cc', e.target.value)}
                  placeholder="15469466"
                  required
                />
              </div>
            </div>
          </CardContent>
        </Card>

        {/* AVI√ÉO */}
        <FormSection
          title="AVI√ÉO"
          icon={<Plane className="h-5 w-5 text-blue-600" />}
          isActive={formData.tem_aviao}
          onToggle={(active) => setFormData(prev => ({ ...prev, tem_aviao: active }))}
        >
          {formData.aviao_viagens.map((viagem, index) => (
            <div key={index} className="border rounded-lg p-4 mb-4 bg-gray-50">
              <div className="flex justify-between items-center mb-3">
                <h4 className="font-semibold">Viagem {index + 1}</h4>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => removeViagem('aviao', index)}
                  disabled={formData.aviao_viagens.length === 1}
                >
                  <Trash2 className="h-4 w-4" />
                </Button>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                  <Label>Origem</Label>
                  <Input
                    value={viagem.origem}
                    onChange={(e) => updateAviaoViagem(index, 'origem', e.target.value)}
                    placeholder="Lisboa"
                  />
                </div>
                <div>
                  <Label>Destino</Label>
                  <Input
                    value={viagem.destino}
                    onChange={(e) => updateAviaoViagem(index, 'destino', e.target.value)}
                    placeholder="Madrid"
                  />
                </div>
                <div>
                  <Label>Data</Label>
                  <Input
                    type="date"
                    value={viagem.data}
                    onChange={(e) => updateAviaoViagem(index, 'data', e.target.value)}
                  />
                </div>
                <div>
                  <Label>Hora Chegada</Label>
                  <Input
                    type="time"
                    value={viagem.hora_chegada}
                    onChange={(e) => updateAviaoViagem(index, 'hora_chegada', e.target.value)}
                  />
                </div>
                <div>
                  <Label>Hora Partida</Label>
                  <Input
                    type="time"
                    value={viagem.hora_partida}
                    onChange={(e) => updateAviaoViagem(index, 'hora_partida', e.target.value)}
                  />
                </div>
                <div className="md:col-span-2 lg:col-span-3">
                  <Label>Observa√ß√µes</Label>
                  <Textarea
                    value={viagem.observacoes}
                    onChange={(e) => updateAviaoViagem(index, 'observacoes', e.target.value)}
                    placeholder="Classe executiva preferencial"
                    rows={2}
                  />
                </div>
              </div>
            </div>
          ))}
          <Button
            variant="outline"
            onClick={() => addViagem('aviao')}
            disabled={formData.aviao_viagens.length >= 6}
            className="w-full"
          >
            <Plus className="h-4 w-4 mr-2" />
            Adicionar Viagem de Avi√£o (m√°x. 6)
          </Button>
        </FormSection>

        {/* ALOJAMENTO */}
        <FormSection
          title="ALOJAMENTO"
          icon={<Hotel className="h-5 w-5 text-green-600" />}
          isActive={formData.tem_alojamento}
          onToggle={(active) => setFormData(prev => ({ ...prev, tem_alojamento: active }))}
        >
          {formData.alojamentos.map((alojamento, index) => (
            <div key={index} className="border rounded-lg p-4 mb-4 bg-gray-50">
              <div className="flex justify-between items-center mb-3">
                <h4 className="font-semibold">Alojamento {index + 1}</h4>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => removeViagem('alojamento', index)}
                  disabled={formData.alojamentos.length === 1}
                >
                  <Trash2 className="h-4 w-4" />
                </Button>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                  <Label>Cidade</Label>
                  <Input
                    value={alojamento.cidade}
                    onChange={(e) => updateAlojamento(index, 'cidade', e.target.value)}
                    placeholder="Lisboa"
                  />
                </div>
                <div>
                  <Label>Hotel</Label>
                  <Input
                    value={alojamento.hotel}
                    onChange={(e) => updateAlojamento(index, 'hotel', e.target.value)}
                    placeholder="Turim Lisboa"
                  />
                </div>
                <div>
                  <Label>Tipo Quarto</Label>
                  <Select
                    value={alojamento.tipo_quarto}
                    onValueChange={(value) => updateAlojamento(index, 'tipo_quarto', value)}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="1PAX">1PAX</SelectItem>
                      <SelectItem value="2PAX">2PAX</SelectItem>
                      <SelectItem value="Suite">Suite</SelectItem>
                      <SelectItem value="Executivo">Executivo</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div>
                  <Label>Data Chegada</Label>
                  <Input
                    type="date"
                    value={alojamento.data_chegada}
                    onChange={(e) => updateAlojamento(index, 'data_chegada', e.target.value)}
                  />
                </div>
                <div>
                  <Label>Data Partida</Label>
                  <Input
                    type="date"
                    value={alojamento.data_partida}
                    onChange={(e) => updateAlojamento(index, 'data_partida', e.target.value)}
                  />
                </div>
                <div className="md:col-span-2 lg:col-span-3">
                  <Label>Observa√ß√µes</Label>
                  <Textarea
                    value={alojamento.observacoes}
                    onChange={(e) => updateAlojamento(index, 'observacoes', e.target.value)}
                    placeholder="Sugiro, se poss√≠vel o Turim Lisboa"
                    rows={2}
                  />
                </div>
              </div>
            </div>
          ))}
          <Button
            variant="outline"
            onClick={() => addViagem('alojamento')}
            disabled={formData.alojamentos.length >= 6}
            className="w-full"
          >
            <Plus className="h-4 w-4 mr-2" />
            Adicionar Alojamento (m√°x. 6)
          </Button>
        </FormSection>

        {/* AUTOM√ìVEL */}
        <FormSection
          title="AUTOM√ìVEL"
          icon={<Car className="h-5 w-5 text-purple-600" />}
          isActive={formData.tem_automovel}
          onToggle={(active) => setFormData(prev => ({ ...prev, tem_automovel: active }))}
        >
          {formData.automoveis.map((auto, index) => (
            <div key={index} className="border rounded-lg p-4 mb-4 bg-gray-50">
              <div className="flex justify-between items-center mb-3">
                <h4 className="font-semibold">Aluguer {index + 1}</h4>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => removeViagem('automovel', index)}
                  disabled={formData.automoveis.length === 1}
                >
                  <Trash2 className="h-4 w-4" />
                </Button>
              </div>
              
              <div className="mb-4">
                <h5 className="font-medium mb-2 text-green-600">Levantamento</h5>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div>
                    <Label>Cidade</Label>
                    <Input
                      value={auto.cidade_levantamento}
                      onChange={(e) => updateAutomovel(index, 'cidade_levantamento', e.target.value)}
                      placeholder="Lisboa"
                    />
                  </div>
                  <div>
                    <Label>Local</Label>
                    <Input
                      value={auto.local_levantamento}
                      onChange={(e) => updateAutomovel(index, 'local_levantamento', e.target.value)}
                      placeholder="Aeroporto"
                    />
                  </div>
                  <div>
                    <Label>Data</Label>
                    <Input
                      type="date"
                      value={auto.data_levantamento}
                      onChange={(e) => updateAutomovel(index, 'data_levantamento', e.target.value)}
                    />
                  </div>
                  <div>
                    <Label>Hora</Label>
                    <Input
                      type="time"
                      value={auto.hora_levantamento}
                      onChange={(e) => updateAutomovel(index, 'hora_levantamento', e.target.value)}
                    />
                  </div>
                </div>
              </div>

              <div className="mb-4">
                <h5 className="font-medium mb-2 text-red-600">Devolu√ß√£o</h5>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div>
                    <Label>Cidade</Label>
                    <Input
                      value={auto.cidade_devolucao}
                      onChange={(e) => updateAutomovel(index, 'cidade_devolucao', e.target.value)}
                      placeholder="Lisboa"
                    />
                  </div>
                  <div>
                    <Label>Local</Label>
                    <Input
                      value={auto.local_devolucao}
                      onChange={(e) => updateAutomovel(index, 'local_devolucao', e.target.value)}
                      placeholder="Aeroporto"
                    />
                  </div>
                  <div>
                    <Label>Data</Label>
                    <Input
                      type="date"
                      value={auto.data_devolucao}
                      onChange={(e) => updateAutomovel(index, 'data_devolucao', e.target.value)}
                    />
                  </div>
                  <div>
                    <Label>Hora</Label>
                    <Input
                      type="time"
                      value={auto.hora_devolucao}
                      onChange={(e) => updateAutomovel(index, 'hora_devolucao', e.target.value)}
                    />
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label>Tipo Viatura</Label>
                  <Select
                    value={auto.tipo_viatura}
                    onValueChange={(value) => updateAutomovel(index, 'tipo_viatura', value)}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Econ√≥mico">Econ√≥mico</SelectItem>
                      <SelectItem value="Compacto">Compacto</SelectItem>
                      <SelectItem value="Interm√©dio">Interm√©dio</SelectItem>
                      <SelectItem value="Standard">Standard</SelectItem>
                      <SelectItem value="Premium">Premium</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div>
                  <Label>Observa√ß√µes</Label>
                  <Textarea
                    value={auto.observacoes}
                    onChange={(e) => updateAutomovel(index, 'observacoes', e.target.value)}
                    placeholder="Prefer√™ncia por transmiss√£o autom√°tica"
                    rows={2}
                  />
                </div>
              </div>
            </div>
          ))}
          <Button
            variant="outline"
            onClick={() => addViagem('automovel')}
            disabled={formData.automoveis.length >= 6}
            className="w-full"
          >
            <Plus className="h-4 w-4 mr-2" />
            Adicionar Aluguer de Autom√≥vel (m√°x. 6)
          </Button>
        </FormSection>

        {/* COMBOIO */}
        <FormSection
          title="COMBOIO"
          icon={<Train className="h-5 w-5 text-orange-600" />}
          isActive={formData.tem_comboio}
          onToggle={(active) => setFormData(prev => ({ ...prev, tem_comboio: active }))}
        >
          <div className="space-y-6">
            {/* Viagem de IDA */}
            <div className="border rounded-lg p-4 bg-green-50">
              <h4 className="font-semibold mb-3 text-green-700">Viagem de Ida</h4>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <div>
                  <Label>Local Partida</Label>
                  <Input
                    value={formData.comboio_ida.local_partida}
                    onChange={(e) => setFormData(prev => ({
                      ...prev,
                      comboio_ida: { ...prev.comboio_ida, local_partida: e.target.value }
                    }))}
                    placeholder="Porto Campanha"
                  />
                </div>
                <div>
                  <Label>Local Destino</Label>
                  <Input
                    value={formData.comboio_ida.local_destino}
                    onChange={(e) => setFormData(prev => ({
                      ...prev,
                      comboio_ida: { ...prev.comboio_ida, local_destino: e.target.value }
                    }))}
                    placeholder="Lisboa Oriente"
                  />
                </div>
                <div>
                  <Label>Data</Label>
                  <Input
                    type="date"
                    value={formData.comboio_ida.data}
                    onChange={(e) => setFormData(prev => ({
                      ...prev,
                      comboio_ida: { ...prev.comboio_ida, data: e.target.value }
                    }))}
                  />
                </div>
                <div>
                  <Label>Hora Partida</Label>
                  <Input
                    type="time"
                    value={formData.comboio_ida.hora_partida}
                    onChange={(e) => setFormData(prev => ({
                      ...prev,
                      comboio_ida: { ...prev.comboio_ida, hora_partida: e.target.value }
                    }))}
                  />
                </div>
                <div>
                  <Label>Comboio/Classe</Label>
                  <Select
                    value={formData.comboio_ida.classe}
                    onValueChange={(value) => setFormData(prev => ({
                      ...prev,
                      comboio_ida: { ...prev.comboio_ida, classe: value }
                    }))}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="Selecionar" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Alfa Pendular">Alfa Pendular</SelectItem>
                      <SelectItem value="Intercidades">Intercidades</SelectItem>
                      <SelectItem value="Regional">Regional</SelectItem>
                      <SelectItem value="Urbano">Urbano</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>
              <div className="mt-4">
                <Label>Observa√ß√µes da Ida</Label>
                <Textarea
                  value={formData.observacoes_ida}
                  onChange={(e) => setFormData(prev => ({ ...prev, observacoes_ida: e.target.value }))}
                  placeholder="Se poss√≠vel virado para a frente"
                  rows={2}
                />
              </div>
            </div>

            {/* Checkbox para viagem de regresso */}
            <div className="flex items-center space-x-2">
              <input
                type="checkbox"
                id="tem_regresso"
                checked={formData.tem_regresso}
                onChange={(e) => setFormData(prev => ({ ...prev, tem_regresso: e.target.checked }))}
                className="w-4 h-4"
              />
              <Label htmlFor="tem_regresso">Incluir viagem de regresso</Label>
            </div>

            {/* Viagem de REGRESSO */}
            {formData.tem_regresso && (
              <div className="border rounded-lg p-4 bg-red-50">
                <h4 className="font-semibold mb-3 text-red-700">Viagem de Regresso</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                  <div>
                    <Label>Local Partida</Label>
                    <Input
                      value={formData.comboio_regresso.local_partida}
                      onChange={(e) => setFormData(prev => ({
                        ...prev,
                        comboio_regresso: { ...prev.comboio_regresso, local_partida: e.target.value }
                      }))}
                      placeholder="Lisboa Oriente"
                    />
                  </div>
                  <div>
                    <Label>Local Destino</Label>
                    <Input
                      value={formData.comboio_regresso.local_destino}
                      onChange={(e) => setFormData(prev => ({
                        ...prev,
                        comboio_regresso: { ...prev.comboio_regresso, local_destino: e.target.value }
                      }))}
                      placeholder="Porto Campanha"
                    />
                  </div>
                  <div>
                    <Label>Data</Label>
                    <Input
                      type="date"
                      value={formData.comboio_regresso.data}
                      onChange={(e) => setFormData(prev => ({
                        ...prev,
                        comboio_regresso: { ...prev.comboio_regresso, data: e.target.value }
                      }))}
                    />
                  </div>
                  <div>
                    <Label>Hora Partida</Label>
                    <Input
                      type="time"
                      value={formData.comboio_regresso.hora_partida}
                      onChange={(e) => setFormData(prev => ({
                        ...prev,
                        comboio_regresso: { ...prev.comboio_regresso, hora_partida: e.target.value }
                      }))}
                    />
                  </div>
                  <div>
                    <Label>Comboio/Classe</Label>
                    <Select
                      value={formData.comboio_regresso.classe}
                      onValueChange={(value) => setFormData(prev => ({
                        ...prev,
                        comboio_regresso: { ...prev.comboio_regresso, classe: value }
                      }))}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Selecionar" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="Alfa Pendular">Alfa Pendular</SelectItem>
                        <SelectItem value="Intercidades">Intercidades</SelectItem>
                        <SelectItem value="Regional">Regional</SelectItem>
                        <SelectItem value="Urbano">Urbano</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>
                <div className="mt-4">
                  <Label>Observa√ß√µes do Regresso</Label>
                  <Textarea
                    value={formData.observacoes_regresso}
                    onChange={(e) => setFormData(prev => ({ ...prev, observacoes_regresso: e.target.value }))}
                    placeholder="Se poss√≠vel virado para a frente"
                    rows={2}
                  />
                </div>
              </div>
            )}
          </div>
        </FormSection>

        {/* OUTROS SERVI√áOS */}
        <FormSection
          title="OUTROS SERVI√áOS"
          icon={<Mail className="h-5 w-5 text-gray-600" />}
          isActive={formData.tem_outros}
          onToggle={(active) => setFormData(prev => ({ ...prev, tem_outros: active }))}
        >
          <div>
            <Label>Outros servi√ßos necess√°rios</Label>
            <Textarea
              value={formData.outros_servicos}
              onChange={(e) => setFormData(prev => ({ ...prev, outros_servicos: e.target.value }))}
              placeholder="Visto para Espanha&#10;Transfer aeroporto-hotel&#10;Seguro de viagem"
              rows={4}
            />
          </div>
        </FormSection>

        {/* BOT√ïES DE A√á√ÉO */}
        <div className="mt-8 flex justify-center space-x-4">
          <Button
            onClick={generateEmail}
            variant="outline"
            className="flex items-center space-x-2"
          >
            <Mail className="h-4 w-4" />
            <span>Gerar Email</span>
          </Button>
          
          <Button
            onClick={generateExcel}
            disabled={loading}
            className="flex items-center space-x-2 bg-green-600 hover:bg-green-700"
          >
            <Download className="h-4 w-4" />
            <span>{loading ? 'Gerando...' : 'Download Template Excel'}</span>
          </Button>
        </div>

        <div className="mt-6 text-center text-sm text-gray-500">
          <p>Template baseado na estrutura oficial do Excel ‚Ä¢ Todos os campos mapeados corretamente</p>
        </div>
      </main>
    </div>
  )
}
